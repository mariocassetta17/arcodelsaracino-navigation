<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigatore Appartamenti - Villa Resort</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .logo {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h1 {
            color: #4a5568;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #718096;
            font-size: 0.9em;
        }

        .welcome-screen, .navigation-screen {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navigation-screen {
            display: none;
        }

        .qr-info {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px dashed #cbd5e0;
        }

        .qr-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #4299e1;
        }

        .gps-status {
            background: #f0fff4;
            border: 2px solid #68d391;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .gps-status.requesting {
            background: #fffaf0;
            border-color: #f6ad55;
        }

        .gps-status.error {
            background: #fed7d7;
            border-color: #fc8181;
        }

        .gps-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .location-info {
            background: #e6fffa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .location-info h4 {
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coordinates {
            font-family: monospace;
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .zone-alert {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-gps {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .navigation-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f7fafc;
        }

        .back-btn {
            background: #f7fafc;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #edf2f7;
            transform: scale(1.1);
        }

        .destination-info {
            flex: 1;
        }

        .destination-info h2 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .eta {
            color: #4299e1;
            font-weight: 600;
        }

        .current-instruction {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .instruction-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .instruction-text {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .instruction-distance {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #f7fafc;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .next-instructions {
            flex: 1;
        }

        .next-instructions h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .instruction-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            background: #f7fafc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 0.8em;
        }

        .step-text {
            flex: 1;
            color: #4a5568;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn:hover {
            border-color: #4299e1;
            background: #f7fafc;
        }

        .control-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header, .welcome-screen, .navigation-screen {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üèñÔ∏è</div>
            <h1>Villa Resort Navigator</h1>
            <p class="subtitle">Sistema di navigazione GPS intelligente</p>
        </div>

        <!-- Schermata di benvenuto -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="qr-info">
                <div class="qr-icon">üì±</div>
                <h3>QR Code Scansionato!</h3>
                <p>Benvenuto nel sistema di navigazione del resort</p>
            </div>

            <div class="gps-status" id="gpsStatus">
                <div class="gps-icon">üìç</div>
                <div id="gpsStatusText">Richiesta accesso GPS...</div>
            </div>

            <div class="location-info" id="locationInfo">
                <h4>üìç Posizione attuale</h4>
                <div class="coordinates" id="coordinates">Lat: -, Lng: -</div>
                <div id="currentZone">Zona: Rilevamento in corso...</div>
            </div>

            <div class="zone-alert" id="zoneAlert">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üö®</div>
                <div id="zoneAlertText">Sei entrato in una nuova zona!</div>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="input-group">
                <label for="apartmentNumber">Inserisci il numero dell'appartamento:</label>
                <input type="number" id="apartmentNumber" placeholder="es. 150" min="101" max="314">
            </div>

            <button class="btn btn-gps" onclick="requestGPS()" id="gpsBtn">
                üìç Attiva GPS e Inizia
            </button>

            <button class="btn" onclick="startNavigation()" id="startBtn" disabled>
                üß≠ Inizia Navigazione
            </button>

            <button class="btn btn-secondary" onclick="showApartmentList()">
                üìã Visualizza Lista Appartamenti
            </button>


        </div>

        <!-- Schermata di navigazione -->
        <div class="navigation-screen" id="navigationScreen">
            <div class="navigation-header">
                <button class="back-btn" onclick="goBack()">‚Üê</button>
                <div class="destination-info">
                    <h2 id="destinationTitle">Appartamento 150</h2>
                    <p class="eta" id="etaInfo">Arrivo stimato: 3 min</p>
                </div>
            </div>

            <div class="location-info" id="navLocationInfo" style="display: block;">
                <h4>üìç Posizione GPS</h4>
                <div class="coordinates" id="navCoordinates">Lat: -, Lng: -</div>
                <div id="navCurrentZone">Zona: Rilevamento in corso...</div>
            </div>

            <div class="zone-alert" id="navZoneAlert">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üéØ</div>
                <div id="navZoneAlertText">Istruzione automatica GPS</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="current-instruction" id="currentInstruction">
                <div class="instruction-icon">üö∂‚Äç‚ôÇÔ∏è</div>
                <div class="instruction-text">Dirigiti verso l'ingresso principale</div>
                <div class="instruction-distance">Tra 50 metri</div>
            </div>

            <div class="next-instructions">
                <h3>Prossimi passi:</h3>
                <div id="nextSteps">
                    <!-- Le istruzioni verranno inserite dinamicamente -->
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" id="voiceBtn" onclick="toggleVoice()">
                    üîä Audio
                </button>
                <button class="control-btn" onclick="recenterMap()">
                    üéØ Centra
                </button>
                <button class="control-btn" onclick="showHelp()">
                    ‚ùì Aiuto
                </button>
            </div>
        </div>
    </div>

    <script>
        // Database degli appartamenti con percorsi dettagliati
        const apartmentRoutes = {};

        // Zone GPS del resort configurate
        const resortZones = {
            // Area Reception - Punto di partenza QR Code
            reception: {
                name: "Area Reception",
                lat: 39.851111,  // Centro dell'area reception
                lng: 18.193500,  // Centro dell'area reception  
                radius: 25,      // Raggio per coprire tutta l'area esterna reception
                message: "üìã Benvenuto! Sei nell'area reception. Il tuo percorso inizia da qui."
            },

            // Zone aggiuntive da configurare in base alle esigenze del resort
            pool: {
                name: "Area Piscina",
                lat: 39.851200,
                lng: 18.193800,
                radius: 60,
                message: "üèä‚Äç‚ôÇÔ∏è Area Piscina: appartamenti nelle vicinanze."
            },

            garden: {
                name: "Giardino",
                lat: 39.851000,
                lng: 18.193200,
                radius: 80,
                message: "üå∫ Giardino: zona relax del resort."
            },

            beach: {
                name: "Zona Mare",
                lat: 39.850800,
                lng: 18.194000,
                radius: 100,
                message: "üèñÔ∏è Zona Mare: appartamenti con vista oceano!"
            }
        };

        // Funzione per generare percorsi automaticamente
        function generateApartmentRoutes() {
            // Appartamenti 101-257 (tutti)
            for (let i = 101; i <= 257; i++) {
                apartmentRoutes[i] = {
                    name: `Appartamento ${i}`,
                    estimatedTime: "3-5 min",
                    steps: [
                        { icon: "üö∂‚Äç‚ôÇÔ∏è", text: "Segui le indicazioni GPS automatiche", distance: "Variabile" },
                        { icon: "üìç", text: "Il sistema ti guider√† zona per zona", distance: "GPS attivo" },
                        { icon: "üéØ", text: "Riceverai istruzioni quando cambi zona", distance: "Automatico" },
                        { icon: "üè†", text: `Arrivo all'appartamento ${i}`, distance: "Destinazione" }
                    ]
                };
            }

            // Appartamenti 258, 260 (solo pari)
            for (let i = 258; i <= 260; i += 2) {
                apartmentRoutes[i] = {
                    name: `Torre Esclusiva - App. ${i}`,
                    estimatedTime: "7 min",
                    steps: [
                        { icon: "üîë", text: "Accesso VIP richiesto", distance: "Security" },
                        { icon: "üìç", text: "GPS ti guider√† alla torre esclusiva", distance: "GPS attivo" },
                        { icon: "üè∞", text: `Suite ${i} - Servizio premium`, distance: "Arrivo" }
                    ]
                };
            }

            // Appartamenti 302-314 (solo pari)
            for (let i = 302; i <= 314; i += 2) {
                apartmentRoutes[i] = {
                    name: `Attico Luxury - App. ${i}`,
                    estimatedTime: "8 min",
                    steps: [
                        { icon: "üîë", text: "Badge dorato richiesto", distance: "VIP Access" },
                        { icon: "üìç", text: "GPS ti guider√† all'attico", distance: "GPS attivo" },
                        { icon: "üíé", text: `Attico ${i} - Luxury Experience`, distance: "Arrivo" }
                    ]
                };
            }
        }

        // Genera tutti gli appartamenti
        generateApartmentRoutes();

        let currentRoute = null;
        let currentStep = 0;
        let voiceEnabled = false;
        let navigationInterval = null;
        let gpsWatchId = null;
        let userLocation = null;
        let gpsEnabled = false;
        let lastTriggeredZone = null;

        // Richiesta permessi GPS
        function requestGPS() {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsStatusText = document.getElementById('gpsStatusText');
            const gpsBtn = document.getElementById('gpsBtn');
            
            // Disabilita il pulsante per evitare click multipli
            gpsBtn.disabled = true;
            gpsBtn.textContent = '‚è≥ Richiesta permessi GPS...';
            
            gpsStatus.style.display = 'block';
            gpsStatus.className = 'gps-status requesting';
            gpsStatusText.textContent = 'üîê Il browser chieder√† i permessi GPS...';

            // Verifica supporto geolocalizzazione
            if (!navigator.geolocation) {
                showGPSError('‚ùå GPS non supportato da questo dispositivo');
                gpsBtn.disabled = false;
                gpsBtn.textContent = 'üìç Riprova Attivazione GPS';
                return;
            }

            // Richiesta esplicita dei permessi GPS
            navigator.geolocation.getCurrentPosition(
                // Successo - permessi concessi
                (position) => {
                    gpsEnabled = true;
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    gpsStatus.className = 'gps-status';
                    gpsStatusText.textContent = '‚úÖ GPS attivato con successo!';
                    
                    // Abilita il pulsante di navigazione
                    document.getElementById('startBtn').disabled = false;
                    
                    // Nascondi il pulsante GPS e mostra info posizione
                    gpsBtn.style.display = 'none';
                    showLocationInfo();
                    startGPSTracking();
                },
                // Errore - permessi negati o altri problemi
                (error) => {
                    let errorMsg = '';
                    let buttonText = 'üìç Riprova Attivazione GPS';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'üö´ Permessi GPS negati. Abilita la geolocalizzazione nelle impostazioni del browser.';
                            buttonText = 'üîÑ Richiedi Permessi GPS';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'üì° Posizione GPS non disponibile. Verifica di essere all\'aperto.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚è∞ Timeout GPS. Riprova tra qualche secondo.';
                            break;
                        default:
                            errorMsg = '‚ùå Errore GPS sconosciuto. Riprova.';
                    }
                    
                    showGPSError(errorMsg);
                    gpsBtn.disabled = false;
                    gpsBtn.textContent = buttonText;
                },
                // Opzioni per forzare la richiesta dei permessi
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0  // Forza una nuova richiesta
                }
            );
        }

        // Mostra errore GPS
        function showGPSError(message) {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsStatusText = document.getElementById('gpsStatusText');
            
            gpsStatus.className = 'gps-status error';
            gpsStatusText.textContent = message;
            
            // Riprova automaticamente dopo 3 secondi
            setTimeout(() => {
                requestGPS();
            }, 3000);
        }

        // Mostra informazioni posizione
        function showLocationInfo() {
            const locationInfo = document.getElementById('locationInfo');
            const coordinates = document.getElementById('coordinates');
            const currentZone = document.getElementById('currentZone');
            
            locationInfo.style.display = 'block';
            coordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            
            const zone = detectCurrentZone();
            currentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
        }

        // Avvia tracking GPS continuo
        function startGPSTracking() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }

            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    updateLocationDisplay();
                    checkZoneEntry();
                },
                (error) => {
                    console.log('Errore tracking GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 30000
                }
            );
        }

        // Aggiorna display posizione
        function updateLocationDisplay() {
            // Aggiorna coordinate nella schermata principale
            const coordinates = document.getElementById('coordinates');
            const currentZone = document.getElementById('currentZone');
            
            if (coordinates) {
                coordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            }
            
            const zone = detectCurrentZone();
            if (currentZone) {
                currentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
            }

            // Aggiorna anche nella schermata di navigazione
            const navCoordinates = document.getElementById('navCoordinates');
            const navCurrentZone = document.getElementById('navCurrentZone');
            
            if (navCoordinates) {
                navCoordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            }
            
            if (navCurrentZone) {
                navCurrentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
            }
        }

        // Rileva zona attuale
        function detectCurrentZone() {
            if (!userLocation) return null;

            for (const [key, zone] of Object.entries(resortZones)) {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    zone.lat, zone.lng
                );
                
                if (distance <= zone.radius) {
                    return zone;
                }
            }
            return null;
        }

        // Calcola distanza tra due punti GPS
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Raggio Terra in metri
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Controlla ingresso in nuova zona
        function checkZoneEntry() {
            const currentZone = detectCurrentZone();
            
            if (currentZone && currentZone !== lastTriggeredZone) {
                lastTriggeredZone = currentZone;
                showZoneAlert(currentZone);
                
                if (voiceEnabled) {
                    speakInstruction(currentZone.message);
                }
            }
        }

        // Mostra alert zona
        function showZoneAlert(zone) {
            const zoneAlert = document.getElementById('zoneAlert');
            const zoneAlertText = document.getElementById('zoneAlertText');
            const navZoneAlert = document.getElementById('navZoneAlert');
            const navZoneAlertText = document.getElementById('navZoneAlertText');
            
            // Alert nella schermata principale
            if (zoneAlert && zoneAlertText) {
                zoneAlertText.textContent = zone.message;
                zoneAlert.style.display = 'block';
                
                setTimeout(() => {
                    zoneAlert.style.display = 'none';
                }, 5000);
            }
            
            // Alert nella schermata di navigazione
            if (navZoneAlert && navZoneAlertText) {
                navZoneAlertText.textContent = zone.message;
                navZoneAlert.style.display = 'block';
                
                setTimeout(() => {
                    navZoneAlert.style.display = 'none';
                }, 5000);
            }
        }

        // Funzione per iniziare la navigazione
        function startNavigation() {
            const apartmentNumber = document.getElementById('apartmentNumber').value;
            const errorMessage = document.getElementById('errorMessage');
            
            if (!apartmentNumber) {
                showError("Inserisci il numero dell'appartamento");
                return;
            }

            if (!gpsEnabled) {
                showError("Attiva prima il GPS per utilizzare la navigazione");
                return;
            }

            if (!apartmentRoutes[apartmentNumber]) {
                showError(`Appartamento ${apartmentNumber} non trovato. Controlla il numero inserito.`);
                return;
            }

            currentRoute = apartmentRoutes[apartmentNumber];
            currentStep = 0;
            
            // Nascondi schermata di benvenuto e mostra navigazione
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('navigationScreen').style.display = 'flex';
            
            // Aggiorna le informazioni di destinazione
            document.getElementById('destinationTitle').textContent = currentRoute.name;
            document.getElementById('etaInfo').textContent = `Arrivo stimato: ${currentRoute.estimatedTime}`;
            
            // Inizia la simulazione della navigazione
            updateNavigation();
            startNavigationSimulation();
        }

        // Funzione per aggiornare la navigazione
        function updateNavigation() {
            if (!currentRoute || currentStep >= currentRoute.steps.length) return;

            const currentInstruction = document.getElementById('currentInstruction');
            const step = currentRoute.steps[currentStep];
            
            currentInstruction.innerHTML = `
                <div class="instruction-icon">${step.icon}</div>
                <div class="instruction-text">${step.text}</div>
                <div class="instruction-distance">${step.distance}</div>
            `;

            // Aggiorna la barra di progresso
            const progress = ((currentStep + 1) / currentRoute.steps.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;

            // Aggiorna i prossimi passi
            updateNextSteps();

            // Audio se abilitato
            if (voiceEnabled) {
                speakInstruction(step.text);
            }
        }

        // Funzione per aggiornare i prossimi passi
        function updateNextSteps() {
            const nextStepsContainer = document.getElementById('nextSteps');
            nextStepsContainer.innerHTML = '';

            for (let i = currentStep + 1; i < Math.min(currentStep + 4, currentRoute.steps.length); i++) {
                const step = currentRoute.steps[i];
                const stepElement = document.createElement('div');
                stepElement.className = 'instruction-item';
                stepElement.innerHTML = `
                    <div class="step-icon">${step.icon}</div>
                    <div class="step-text">${step.text}</div>
                `;
                nextStepsContainer.appendChild(stepElement);
            }

            if (currentStep >= currentRoute.steps.length - 1) {
                nextStepsContainer.innerHTML = '<div class="instruction-item"><div class="step-icon">üéâ</div><div class="step-text">Sei arrivato a destinazione!</div></div>';
            }
        }

        // Simulazione della navigazione GPS
        function startNavigationSimulation() {
            navigationInterval = setInterval(() => {
                if (currentStep < currentRoute.steps.length - 1) {
                    currentStep++;
                    updateNavigation();
                } else {
                    // Navigazione completata
                    clearInterval(navigationInterval);
                    showArrivalMessage();
                }
            }, 6000); // Cambia istruzione ogni 6 secondi per dare tempo al GPS
        }

        // Messaggio di arrivo
        function showArrivalMessage() {
            const currentInstruction = document.getElementById('currentInstruction');
            currentInstruction.innerHTML = `
                <div class="instruction-icon">üéâ</div>
                <div class="instruction-text">Sei arrivato!</div>
                <div class="instruction-distance">Benvenuto nel tuo appartamento</div>
            `;
            currentInstruction.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
            
            if (voiceEnabled) {
                speakInstruction("Sei arrivato a destinazione! Benvenuto nel tuo appartamento.");
            }
        }

        // Funzione per il text-to-speech
        function speakInstruction(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // Toggle audio
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (voiceEnabled) {
                voiceBtn.classList.add('active');
                voiceBtn.innerHTML = 'üîä Audio ON';
                speakInstruction("Audio attivato");
            } else {
                voiceBtn.classList.remove('active');
                voiceBtn.innerHTML = 'üîä Audio OFF';
            }
        }

        // Funzioni di utilit√†
        function goBack() {
            if (navigationInterval) {
                clearInterval(navigationInterval);
            }
            document.getElementById('navigationScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            document.getElementById('apartmentNumber').value = '';
            hideError();
        }

        function recenterMap() {
            // Simula il ricentramento della mappa
            const btn = event.target;
            btn.style.background = '#4299e1';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.background = 'white';
                btn.style.color = '#333';
            }, 1000);
        }

        function showHelp() {
            alert(`üèñÔ∏è Villa Resort Navigator GPS

Come usare:
1. Attiva il GPS cliccando "Attiva GPS"
2. Inserisci il numero dell'appartamento
3. Il sistema ti guider√† automaticamente
4. Riceverai notifiche quando entri in nuove zone
5. Attiva l'audio per le indicazioni vocali

Funzionalit√† GPS:
‚Ä¢ Rilevamento automatico della zona
‚Ä¢ Notifiche quando cambi area
‚Ä¢ Coordinate in tempo reale
‚Ä¢ Istruzioni contestuali

Appartamenti disponibili:
‚Ä¢ 101-257 (tutti i numeri)
‚Ä¢ 258, 260 (Torre Esclusiva)
‚Ä¢ 302, 304, 306, 308, 310, 312, 314 (Attico Luxury)

Per assistenza: +39 123 456 789`);
        }

        function showApartmentList() {
            let listText = "üèñÔ∏è APPARTAMENTI DISPONIBILI:\n\n";
            listText += "üìç SISTEMA GPS ATTIVO\n";
            listText += "Il sistema rilever√† automaticamente la tua zona\n\n";
            listText += "üè¢ APPARTAMENTI:\n";
            listText += "‚Ä¢ 101-257 (tutti i numeri)\n";
            listText += "‚Ä¢ 258, 260 (Torre Esclusiva)\n";
            listText += "‚Ä¢ 302-314 (solo pari - Attico Luxury)\n\n";
            listText += "üéØ ZONE GPS MONITORATE:\n";
            listText += "‚Ä¢ Area Reception (punto partenza)\n";
            listText += "‚Ä¢ Area Piscina\n";
            listText += "‚Ä¢ Giardino\n";
            listText += "‚Ä¢ Zona Mare\n\n";
            listText += "Attiva il GPS per ricevere indicazioni automatiche!";
            alert(listText);
        }



        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Non attivare GPS automaticamente - deve essere richiesto dall'utente

        // Cleanup GPS quando si chiude la pagina
        window.addEventListener('beforeunload', () => {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }
        });

        // Gestione input con Enter
        document.getElementById('apartmentNumber').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startNavigation();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b98b72232dedb3',t:'MTc1NzI4MzExNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
