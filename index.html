<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Resort GPS Navigator - GitHub Pages</title>
    <meta name="description" content="Sistema di navigazione GPS per Villa Resort - Hostato su GitHub Pages">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .logo {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h1 {
            color: #4a5568;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #718096;
            font-size: 0.9em;
        }

        .github-badge {
            background: #24292e;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-top: 10px;
            display: inline-block;
        }

        .welcome-screen, .navigation-screen {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .navigation-screen {
            display: none;
        }

        .qr-info {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px dashed #cbd5e0;
        }

        .qr-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #4299e1;
        }

        .github-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .github-info h3 {
            color: #0c4a6e;
            margin-bottom: 10px;
        }

        .github-info p {
            color: #0369a1;
            font-size: 0.9em;
        }

        .gps-status {
            background: #f0fff4;
            border: 2px solid #68d391;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .gps-status.requesting {
            background: #fffaf0;
            border-color: #f6ad55;
        }

        .gps-status.error {
            background: #fed7d7;
            border-color: #fc8181;
        }

        .gps-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .location-info {
            background: #e6fffa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .location-info h4 {
            color: #2d3748;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coordinates {
            font-family: monospace;
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .zone-alert {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        input:disabled {
            background-color: #f7fafc;
            color: #a0aec0;
            border-color: #e2e8f0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-gps {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .btn-github {
            background: linear-gradient(135deg, #24292e, #1a1e22);
        }

        .navigation-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f7fafc;
        }

        .back-btn {
            background: #f7fafc;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #edf2f7;
            transform: scale(1.1);
        }

        .destination-info {
            flex: 1;
        }

        .destination-info h2 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .eta {
            color: #4299e1;
            font-weight: 600;
        }

        .current-instruction {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .instruction-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .instruction-text {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .instruction-distance {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #f7fafc;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .next-instructions {
            flex: 1;
        }

        .next-instructions h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .instruction-item:last-child {
            border-bottom: none;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            background: #f7fafc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 0.8em;
        }

        .step-text {
            flex: 1;
            color: #4a5568;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn:hover {
            border-color: #4299e1;
            background: #f7fafc;
        }

        .control-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .install-prompt button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header, .welcome-screen, .navigation-screen {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üèñÔ∏è</div>
            <h1>Villa Resort Navigator</h1>
            <p class="subtitle">Sistema di navigazione GPS - GitHub Pages</p>
            <div class="github-badge">üöÄ Hostato su GitHub</div>
        </div>

        <!-- Schermata di benvenuto -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="github-info">
                <h3>üåê Web App Completa</h3>
                <p>Ora con pieno accesso GPS grazie a GitHub Pages!</p>
            </div>

            <div class="install-prompt" id="installPrompt">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üì±</div>
                <p><strong>Installa l'app sul tuo dispositivo!</strong></p>
                <p>Aggiungi alla schermata home per un'esperienza nativa</p>
                <button onclick="installApp()">üì≤ Installa App</button>
            </div>

            <div class="qr-info">
                <div class="qr-icon">üì±</div>
                <h3>Villa Resort Navigator</h3>
                <p>Sistema di navigazione GPS professionale</p>

            </div>

            <div class="gps-status" id="gpsStatus">
                <div class="gps-icon">üìç</div>
                <div id="gpsStatusText">Richiesta accesso GPS...</div>
            </div>

            <div class="location-info" id="locationInfo">
                <h4>üìç Posizione GPS attuale</h4>
                <div class="coordinates" id="coordinates">Lat: -, Lng: -</div>
                <div id="currentZone">Zona: Rilevamento in corso...</div>
                <div style="font-size: 0.8em; color: #718096; margin-top: 8px;">
                    Precisione: <span id="accuracy">-</span>m
                </div>
            </div>

            <div class="zone-alert" id="zoneAlert">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üö®</div>
                <div id="zoneAlertText">Sei entrato in una nuova zona!</div>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="input-group">
                <label for="apartmentNumber">Inserisci il numero dell'appartamento:</label>
                <input type="number" id="apartmentNumber" placeholder="es. 150" min="101" max="314" disabled>
                <div id="inputWarning" style="margin-top: 8px; padding: 10px; background: #fed7d7; color: #c53030; border-radius: 8px; font-size: 0.9em; display: block;">
                    üö´ Devi essere nell'Area Esterna Reception o Fronte Ristorante per inserire l'appartamento
                </div>
            </div>

            <button class="btn" onclick="startNavigation()" id="startBtn">
                üß≠ Inizia Navigazione
            </button>
        </div>

        <!-- Schermata di navigazione -->
        <div class="navigation-screen" id="navigationScreen">
            <div class="navigation-header">
                <button class="back-btn" onclick="goBack()">‚Üê</button>
                <div class="destination-info">
                    <h2 id="destinationTitle">Appartamento 150</h2>
                    <p class="eta" id="etaInfo">Arrivo stimato: 3 min</p>
                </div>
            </div>

            <div class="location-info" id="navLocationInfo" style="display: none;">
                <h4>üìç Posizione GPS in tempo reale</h4>
                <div class="coordinates" id="navCoordinates">Lat: -, Lng: -</div>
                <div id="navCurrentZone">Zona: Rilevamento in corso...</div>
                <div style="font-size: 0.8em; color: #718096; margin-top: 8px;">
                    Precisione: <span id="navAccuracy">-</span>m | Velocit√†: <span id="speed">-</span> km/h
                </div>
            </div>

            <div class="zone-alert" id="navZoneAlert">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üéØ</div>
                <div id="navZoneAlertText">Istruzione automatica GPS</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="current-instruction" id="currentInstruction">
                <div class="instruction-icon">üö∂‚Äç‚ôÇÔ∏è</div>
                <div class="instruction-text">Dirigiti verso l'ingresso principale</div>
                <div class="instruction-distance">Tra 50 metri</div>
            </div>

            <div class="next-instructions">
                <h3>Prossimi passi:</h3>
                <div id="nextSteps">
                    <!-- Le istruzioni verranno inserite dinamicamente -->
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" id="voiceBtn" onclick="toggleVoice()">
                    üîä Audio
                </button>
                <button class="control-btn" onclick="recenterMap()">
                    üéØ Centra
                </button>
                <button class="control-btn" onclick="shareLocation()">
                    üì§ Condividi
                </button>
                <button class="control-btn" onclick="showHelp()">
                    ‚ùì Aiuto
                </button>
            </div>
        </div>
    </div>

    <script>
        // Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installata');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        // Database degli appartamenti con percorsi dettagliati
        const apartmentRoutes = {};

        // Area poligonale esatta della Reception (coordinate precise)
        const receptionPolygon = [
            { lat: 39.851111, lng: 18.193389 }, // 39¬∞51'04.0"N 18¬∞11'36.2"E
            { lat: 39.851111, lng: 18.1935 },   // 39¬∞51'04.0"N 18¬∞11'36.6"E
            { lat: 39.851028, lng: 18.1935 },   // 39¬∞51'03.7"N 18¬∞11'36.6"E
            { lat: 39.851028, lng: 18.193417 }  // 39¬∞51'03.7"N 18¬∞11'36.3"E
        ];

        // Area 2: Fronte Ristorante (coordinate precise)
        const restaurantPolygon = [
            { lat: 39.851128, lng: 18.193167 }, // 39¬∞51'04.6"N 18¬∞11'35.4"E
            { lat: 39.851125, lng: 18.193167 }, // 39¬∞51'04.5"N 18¬∞11'35.4"E
            { lat: 39.851122, lng: 18.193139 }, // 39¬∞51'04.4"N 18¬∞11'35.3"E
            { lat: 39.851128, lng: 18.193056 }, // 39¬∞51'04.6"N 18¬∞11'35.0"E
            { lat: 39.851131, lng: 18.193083 }  // 39¬∞51'04.7"N 18¬∞11'35.1"E
        ];

        // Zone GPS del resort configurate (coordinate reali)
        const resortZones = {
            reception: {
                name: "Area Esterna Reception",
                polygon: receptionPolygon,
                message: "üìã Perfetto! Sei nell'area esterna della reception. La navigazione pu√≤ iniziare da qui."
            },
            restaurant: {
                name: "Fronte Ristorante",
                polygon: restaurantPolygon,
                message: "üçΩÔ∏è Fronte Ristorante: zona autorizzata per la navigazione."
            },
            pool: {
                name: "Area Piscina",
                lat: 39.851200,
                lng: 18.193800,
                radius: 60,
                message: "üèä‚Äç‚ôÇÔ∏è Area Piscina del resort."
            },
            garden: {
                name: "Giardino",
                lat: 39.851000,
                lng: 18.193200,
                radius: 80,
                message: "üå∫ Giardino: zona relax del resort."
            },
            beach: {
                name: "Zona Mare",
                lat: 39.850800,
                lng: 18.194000,
                radius: 100,
                message: "üèñÔ∏è Zona Mare: appartamenti con vista oceano!"
            }
        };

        // Genera percorsi appartamenti
        function generateApartmentRoutes() {
            // Appartamenti 101-234 (tranne 233) e 306-314
            for (let i = 101; i <= 257; i++) {
                let steps = [];
                
                if ((i >= 101 && i <= 234 && i !== 233) || (i >= 306 && i <= 314)) {
                    // Appartamenti con percorso specifico
                    steps = [
                        { 
                            icon: "üö∂‚Äç‚ôÇÔ∏è", 
                            text: "Uscendo dalla reception svolta a destra e prosegui dritto", 
                            distance: "Dall'area reception",
                            zone: "reception"
                        },
                        { 
                            icon: "üçΩÔ∏è", 
                            text: getRestaurantInstruction(i), 
                            distance: "Area ristorante",
                            zone: "restaurant"
                        },
                        { 
                            icon: "üìç", 
                            text: "Continua seguendo le indicazioni GPS", 
                            distance: "GPS attivo" 
                        },
                        { 
                            icon: "üè†", 
                            text: `Arrivo all'appartamento ${i}`, 
                            distance: "Destinazione" 
                        }
                    ];
                } else {
                    // Altri appartamenti con istruzioni generiche
                    steps = [
                        { icon: "üö∂‚Äç‚ôÇÔ∏è", text: "Segui le indicazioni GPS in tempo reale", distance: "GPS attivo" },
                        { icon: "üìç", text: "Il sistema ti guider√† automaticamente", distance: "Tracking attivo" },
                        { icon: "üéØ", text: "Riceverai notifiche per ogni zona", distance: "Automatico" },
                        { icon: "üè†", text: `Arrivo all'appartamento ${i}`, distance: "Destinazione" }
                    ];
                }
                
                apartmentRoutes[i] = {
                    name: `Appartamento ${i}`,
                    estimatedTime: "3-5 min",
                    steps: steps
                };
            }
            
            // Funzione per determinare l'istruzione al ristorante
            function getRestaurantInstruction(apartmentNumber) {
                if (apartmentNumber === 101 || apartmentNumber === 102 || apartmentNumber === 231) {
                    return "Svolta a destra nel viale adiacente al ristorante";
                } else {
                    return "Svolta leggermente a destra e prosegui dritto";
                }
            }

            for (let i = 258; i <= 260; i += 2) {
                apartmentRoutes[i] = {
                    name: `Torre Esclusiva - App. ${i}`,
                    estimatedTime: "7 min",
                    steps: [
                        { icon: "üîë", text: "Accesso VIP richiesto", distance: "Security" },
                        { icon: "üìç", text: "GPS ti guider√† alla torre esclusiva", distance: "GPS attivo" },
                        { icon: "üè∞", text: `Suite ${i} - Servizio premium`, distance: "Arrivo" }
                    ]
                };
            }

            for (let i = 302; i <= 314; i += 2) {
                apartmentRoutes[i] = {
                    name: `Attico Luxury - App. ${i}`,
                    estimatedTime: "8 min",
                    steps: [
                        { icon: "üîë", text: "Badge dorato richiesto", distance: "VIP Access" },
                        { icon: "üìç", text: "GPS ti guider√† all'attico", distance: "GPS attivo" },
                        { icon: "üíé", text: `Attico ${i} - Luxury Experience`, distance: "Arrivo" }
                    ]
                };
            }
        }

        generateApartmentRoutes();

        let currentRoute = null;
        let currentStep = 0;
        let voiceEnabled = false;
        let navigationInterval = null;
        let gpsWatchId = null;
        let userLocation = null;
        let gpsEnabled = false;
        let lastTriggeredZone = null;

        // Richiesta GPS automatica
        function requestGPS() {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsStatusText = document.getElementById('gpsStatusText');
            const startBtn = document.getElementById('startBtn');
            
            gpsStatus.style.display = 'block';
            gpsStatus.className = 'gps-status requesting';
            gpsStatusText.textContent = 'üîê Richiesta permessi GPS in corso...';

            if (!navigator.geolocation) {
                showGPSError('‚ùå GPS non supportato da questo dispositivo');
                return;
            }

            // Richiesta GPS con alta precisione
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    gpsEnabled = true;
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed
                    };
                    
                    gpsStatus.className = 'gps-status';
                    gpsStatusText.textContent = '‚úÖ GPS attivato con successo!';
                    
                    showLocationInfo();
                    startGPSTracking();
                    
                    // Riprova automaticamente la navigazione se era stata richiesta
                    const apartmentNumber = document.getElementById('apartmentNumber').value;
                    if (apartmentNumber) {
                        setTimeout(() => startNavigation(), 1000);
                    }
                },
                (error) => {
                    let errorMsg = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'üö´ Permessi GPS negati. Su GitHub Pages hai pieno controllo - abilita la geolocalizzazione!';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'üì° Posizione non disponibile. Verifica la connessione GPS.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚è∞ Timeout GPS. Riprova.';
                            break;
                        default:
                            errorMsg = '‚ùå Errore GPS. GitHub Pages supporta completamente la geolocalizzazione.';
                    }
                    
                    showGPSError(errorMsg);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        function showGPSError(message) {
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsStatusText = document.getElementById('gpsStatusText');
            
            gpsStatus.className = 'gps-status error';
            gpsStatusText.textContent = message;
        }

        function showLocationInfo() {
            const locationInfo = document.getElementById('locationInfo');
            const coordinates = document.getElementById('coordinates');
            const currentZone = document.getElementById('currentZone');
            const accuracy = document.getElementById('accuracy');
            
            locationInfo.style.display = 'block';
            coordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            accuracy.textContent = Math.round(userLocation.accuracy || 0);
            
            const zone = detectCurrentZone();
            currentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
            
            // Controlla l'accesso all'input
            updateInputAccess();
        }

        function updateInputAccess() {
            const apartmentInput = document.getElementById('apartmentNumber');
            const inputWarning = document.getElementById('inputWarning');
            const startBtn = document.getElementById('startBtn');
            
            const isInAuthorizedArea = isUserInAuthorizedArea();
            
            if (isInAuthorizedArea) {
                // Utente in area autorizzata - abilita input
                apartmentInput.disabled = false;
                apartmentInput.placeholder = "es. 150";
                inputWarning.style.display = 'none';
                startBtn.disabled = false;
                startBtn.textContent = 'üß≠ Inizia Navigazione';
            } else {
                // Utente fuori dalle aree autorizzate - disabilita input
                apartmentInput.disabled = true;
                apartmentInput.value = '';
                apartmentInput.placeholder = "Accesso limitato - vai alla Reception o Ristorante";
                inputWarning.style.display = 'block';
                startBtn.disabled = true;
                startBtn.textContent = 'üö´ Area Autorizzata Richiesta';
            }
        }

        function startGPSTracking() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }

            gpsWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed
                    };
                    
                    updateLocationDisplay();
                    checkZoneEntry();
                },
                (error) => {
                    console.log('Errore tracking GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 5000
                }
            );
        }

        function updateLocationDisplay() {
            // Aggiorna schermata principale
            const coordinates = document.getElementById('coordinates');
            const currentZone = document.getElementById('currentZone');
            const accuracy = document.getElementById('accuracy');
            
            if (coordinates) {
                coordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            }
            if (accuracy) {
                accuracy.textContent = Math.round(userLocation.accuracy || 0);
            }
            
            const zone = detectCurrentZone();
            if (currentZone) {
                currentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
            }

            // Controlla se l'utente √® nell'area reception e abilita/disabilita l'input
            updateInputAccess();

            // Aggiorna schermata navigazione
            const navCoordinates = document.getElementById('navCoordinates');
            const navCurrentZone = document.getElementById('navCurrentZone');
            const navAccuracy = document.getElementById('navAccuracy');
            const speed = document.getElementById('speed');
            
            if (navCoordinates) {
                navCoordinates.textContent = `Lat: ${userLocation.lat.toFixed(6)}, Lng: ${userLocation.lng.toFixed(6)}`;
            }
            if (navAccuracy) {
                navAccuracy.textContent = Math.round(userLocation.accuracy || 0);
            }
            if (speed) {
                const speedKmh = userLocation.speed ? (userLocation.speed * 3.6).toFixed(1) : '0';
                speed.textContent = speedKmh;
            }
            if (navCurrentZone) {
                navCurrentZone.textContent = `Zona: ${zone ? zone.name : 'Zona non riconosciuta'}`;
            }
        }

        function detectCurrentZone() {
            if (!userLocation) return null;

            // Controllo speciale per l'area reception (poligonale)
            if (isPointInPolygon(userLocation, receptionPolygon)) {
                return resortZones.reception;
            }

            // Controllo speciale per l'area ristorante (poligonale)
            if (isPointInPolygon(userLocation, restaurantPolygon)) {
                return resortZones.restaurant;
            }

            // Controllo per le altre zone (circolari)
            for (const [key, zone] of Object.entries(resortZones)) {
                if (key === 'reception' || key === 'restaurant') continue; // Gi√† controllate sopra
                
                if (zone.lat && zone.lng && zone.radius) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        zone.lat, zone.lng
                    );
                    
                    if (distance <= zone.radius) {
                        return zone;
                    }
                }
            }
            return null;
        }

        // Funzione per verificare se un punto √® dentro un poligono
        function isPointInPolygon(point, polygon) {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                if (((polygon[i].lng > point.lng) !== (polygon[j].lng > point.lng)) &&
                    (point.lat < (polygon[j].lat - polygon[i].lat) * (point.lng - polygon[i].lng) / (polygon[j].lng - polygon[i].lng) + polygon[i].lat)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function checkZoneEntry() {
            const currentZone = detectCurrentZone();
            
            if (currentZone && currentZone !== lastTriggeredZone) {
                lastTriggeredZone = currentZone;
                showZoneAlert(currentZone);
                
                // Se siamo in navigazione, controlla le istruzioni specifiche per zona
                if (currentRoute) {
                    checkZoneBasedNavigation();
                } else if (voiceEnabled) {
                    speakInstruction(currentZone.message);
                }
            }
        }

        function showZoneAlert(zone) {
            const zoneAlert = document.getElementById('zoneAlert');
            const zoneAlertText = document.getElementById('zoneAlertText');
            const navZoneAlert = document.getElementById('navZoneAlert');
            const navZoneAlertText = document.getElementById('navZoneAlertText');
            
            if (zoneAlert && zoneAlertText) {
                zoneAlertText.textContent = zone.message;
                zoneAlert.style.display = 'block';
                setTimeout(() => zoneAlert.style.display = 'none', 5000);
            }
            
            if (navZoneAlert && navZoneAlertText) {
                navZoneAlertText.textContent = zone.message;
                navZoneAlert.style.display = 'block';
                setTimeout(() => navZoneAlert.style.display = 'none', 5000);
            }
        }

        function startNavigation() {
            const apartmentNumber = document.getElementById('apartmentNumber').value;
            
            if (!apartmentNumber) {
                showError("Inserisci il numero dell'appartamento");
                return;
            }

            // Attiva automaticamente il GPS se non √® gi√† attivo
            if (!gpsEnabled) {
                requestGPS();
                return;
            }

            // CONTROLLO RIGOROSO: Devi essere in un'area autorizzata
            const currentZone = detectCurrentZone();
            const isInAuthorizedArea = isUserInAuthorizedArea();
            
            if (!isInAuthorizedArea) {
                showError(`üö´ ACCESSO NEGATO! 
                
Devi essere in una delle AREE AUTORIZZATE per iniziare la navigazione.
                
üìç Posizione attuale: ${currentZone ? currentZone.name : 'Zona sconosciuta'}
üìê Aree autorizzate: 
   ‚Ä¢ Area Esterna Reception (39¬∞51'04.0"N 18¬∞11'36.2"E)
   ‚Ä¢ Fronte Ristorante (39¬∞51'04.6"N 18¬∞11'35.4"E)

üö∂‚Äç‚ôÇÔ∏è Recati in una delle aree autorizzate e riprova!`);
                return;
            }

            if (!apartmentRoutes[apartmentNumber]) {
                showError(`Appartamento ${apartmentNumber} non trovato.`);
                return;
            }

            // Navigazione autorizzata - sei nell'area esterna della Reception!
            currentRoute = apartmentRoutes[apartmentNumber];
            currentStep = 0;
            
            setTimeout(() => {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('navigationScreen').style.display = 'flex';
                
                document.getElementById('destinationTitle').textContent = currentRoute.name;
                document.getElementById('etaInfo').textContent = `Arrivo stimato: ${currentRoute.estimatedTime}`;
                
                updateNavigation();
                startNavigationSimulation();
            }, 1500);
        }

        // Funzione per controllo rigoroso Area Reception (poligonale)
        function isUserInReceptionArea() {
            if (!userLocation) return false;
            
            // Controllo se l'utente √® dentro il poligono esatto della reception
            return isPointInPolygon(userLocation, receptionPolygon);
        }

        // Funzione per controllo aree autorizzate (Reception O Ristorante)
        function isUserInAuthorizedArea() {
            if (!userLocation) return false;
            
            // Controllo se l'utente √® in una delle aree autorizzate
            return isPointInPolygon(userLocation, receptionPolygon) || 
                   isPointInPolygon(userLocation, restaurantPolygon);
        }

        // Funzione per mostrare messaggi di successo
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = '#d4edda';
            errorDiv.style.color = '#155724';
            errorDiv.style.border = '2px solid #c3e6cb';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
                errorDiv.style.background = '#fed7d7';
                errorDiv.style.color = '#c53030';
                errorDiv.style.border = 'none';
            }, 3000);
        }

        function updateNavigation() {
            if (!currentRoute || currentStep >= currentRoute.steps.length) return;

            const currentInstruction = document.getElementById('currentInstruction');
            const step = currentRoute.steps[currentStep];
            
            currentInstruction.innerHTML = `
                <div class="instruction-icon">${step.icon}</div>
                <div class="instruction-text">${step.text}</div>
                <div class="instruction-distance">${step.distance}</div>
            `;

            const progress = ((currentStep + 1) / currentRoute.steps.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;

            updateNextSteps();

            if (voiceEnabled) {
                speakInstruction(step.text);
            }
        }

        // Sistema di navigazione basato su zone GPS
        function checkZoneBasedNavigation() {
            if (!currentRoute || !userLocation) return;
            
            const currentZone = detectCurrentZone();
            if (!currentZone) return;
            
            // Trova il passo corrispondente alla zona attuale
            const zoneStep = currentRoute.steps.find(step => step.zone === getZoneKey(currentZone));
            
            if (zoneStep && currentRoute.steps[currentStep] !== zoneStep) {
                // Aggiorna automaticamente al passo corretto per la zona
                const stepIndex = currentRoute.steps.indexOf(zoneStep);
                if (stepIndex !== -1 && stepIndex !== currentStep) {
                    currentStep = stepIndex;
                    updateNavigation();
                    
                    // Mostra notifica di cambio zona
                    showZoneNavigationAlert(zoneStep);
                }
            }
        }
        
        function getZoneKey(zone) {
            if (zone === resortZones.reception) return 'reception';
            if (zone === resortZones.restaurant) return 'restaurant';
            return null;
        }
        
        function showZoneNavigationAlert(step) {
            const navZoneAlert = document.getElementById('navZoneAlert');
            const navZoneAlertText = document.getElementById('navZoneAlertText');
            
            if (navZoneAlert && navZoneAlertText) {
                navZoneAlertText.textContent = `üß≠ ${step.text}`;
                navZoneAlert.style.display = 'block';
                setTimeout(() => navZoneAlert.style.display = 'none', 8000);
                
                if (voiceEnabled) {
                    speakInstruction(step.text);
                }
            }
        }

        function updateNextSteps() {
            const nextStepsContainer = document.getElementById('nextSteps');
            nextStepsContainer.innerHTML = '';

            for (let i = currentStep + 1; i < Math.min(currentStep + 4, currentRoute.steps.length); i++) {
                const step = currentRoute.steps[i];
                const stepElement = document.createElement('div');
                stepElement.className = 'instruction-item';
                stepElement.innerHTML = `
                    <div class="step-icon">${step.icon}</div>
                    <div class="step-text">${step.text}</div>
                `;
                nextStepsContainer.appendChild(stepElement);
            }

            if (currentStep >= currentRoute.steps.length - 1) {
                nextStepsContainer.innerHTML = '<div class="instruction-item"><div class="step-icon">üéâ</div><div class="step-text">Sei arrivato a destinazione!</div></div>';
            }
        }

        function startNavigationSimulation() {
            // La navigazione ora √® completamente basata su GPS e zone
            // Non c'√® pi√π progressione automatica temporizzata
            // Le istruzioni cambiano solo quando l'utente entra fisicamente nelle zone GPS
            
            // Controlla immediatamente se siamo gi√† in una zona specifica
            checkZoneBasedNavigation();
        }

        function showArrivalMessage() {
            const currentInstruction = document.getElementById('currentInstruction');
            currentInstruction.innerHTML = `
                <div class="instruction-icon">üéâ</div>
                <div class="instruction-text">Sei arrivato!</div>
                <div class="instruction-distance">Benvenuto nel tuo appartamento</div>
            `;
            currentInstruction.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
            
            if (voiceEnabled) {
                speakInstruction("Sei arrivato a destinazione! Benvenuto nel tuo appartamento.");
            }
        }

        function speakInstruction(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (voiceEnabled) {
                voiceBtn.classList.add('active');
                voiceBtn.innerHTML = 'üîä Audio ON';
                speakInstruction("Audio attivato");
            } else {
                voiceBtn.classList.remove('active');
                voiceBtn.innerHTML = 'üîä Audio OFF';
            }
        }

        function shareLocation() {
            if (navigator.share && userLocation) {
                navigator.share({
                    title: 'La mia posizione - Villa Resort',
                    text: `Sono qui: Lat ${userLocation.lat.toFixed(6)}, Lng ${userLocation.lng.toFixed(6)}`,
                    url: `https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`
                });
            } else if (userLocation) {
                const url = `https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`;
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link posizione copiato negli appunti!');
                });
            }
        }

        function goBack() {
            if (navigationInterval) {
                clearInterval(navigationInterval);
            }
            document.getElementById('navigationScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            document.getElementById('apartmentNumber').value = '';
            hideError();
        }

        function recenterMap() {
            const btn = event.target;
            btn.style.background = '#4299e1';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.background = 'white';
                btn.style.color = '#333';
            }, 1000);
        }

        function showHelp() {
            alert(`üèñÔ∏è VILLA RESORT GPS NAVIGATOR

üö´ CONTROLLO ACCESSO RIGOROSO:
La navigazione √® BLOCCATA se non sei in un'area autorizzata!

üéØ PROCEDURA OBBLIGATORIA:
1. Vai FISICAMENTE in una delle AREE AUTORIZZATE:
   ‚Ä¢ Area Esterna Reception
   ‚Ä¢ Fronte Ristorante
2. Attendi che il GPS rilevi la tua posizione
3. Verifica che mostri una delle zone autorizzate
4. Solo allora inserisci il numero appartamento
5. Clicca "Inizia Navigazione"

‚ö†Ô∏è SISTEMA DI SICUREZZA POLIGONALE:
‚Ä¢ AREA 1 - Reception: 39¬∞51'04.0"N 18¬∞11'36.2"E (+ altre 3 coordinate)
‚Ä¢ AREA 2 - Ristorante: 39¬∞51'04.6"N 18¬∞11'35.4"E (+ altre 4 coordinate)
‚Ä¢ Controllo GPS in tempo reale
‚Ä¢ Accesso negato se fuori dai poligoni esatti
‚Ä¢ Rilevamento automatico della posizione

üè¢ APPARTAMENTI DISPONIBILI:
‚Ä¢ 101-257 (tutti i numeri)
‚Ä¢ 258, 260 (Torre Esclusiva - VIP)
‚Ä¢ 302-314 (solo pari - Attico Luxury)

üìç Se il sistema ti blocca, significa che NON sei dentro uno dei poligoni autorizzati!

üìû Assistenza: +39 123 456 789`);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Attivazione GPS automatica al caricamento della pagina
        window.addEventListener('load', () => {
            // Attiva automaticamente il GPS quando la pagina si carica
            setTimeout(() => {
                requestGPS();
            }, 1000);
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }
        });

        // Enter key support
        document.getElementById('apartmentNumber').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startNavigation();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97b9ca6da08ac4e2',t:'MTc1NzI4NTY5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
