<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Guida al villaggio</title>
</head>
<body>
  <h2>Guida al tuo appartamento</h2>
  
  <div id="inputDiv">
    <label for="aptNumber">Inserisci numero appartamento:</label>
    <input type="text" id="aptNumber">
    <button onclick="startRoute()">Inizia</button>
  </div>

  <div id="output">Attendi...</div>

  <script>
    let checkpoints = [];
    const RADIUS = 20; // metri
    let currentStep = 0;

    // Definizione dei checkpoint per appartamenti diversi
    const apartments = {
      "101": [
        {lat: 41.22880, lng: 16.30620, msg: "Sei al cancello principale, gira a sinistra."},
        {lat: 41.22890, lng: 16.30630, msg: "Alla fontana, prosegui dritto."},
        {lat: 41.22900, lng: 16.30640, msg: "Arrivato al palazzo 101, appartamento al piano 2."}
      ],
      "102": [
        {lat: 41.22880, lng: 16.30620, msg: "Sei al cancello principale, gira a destra."},
        {lat: 41.22885, lng: 16.30625, msg: "Prosegui fino all’albero grande, poi gira a sinistra."},
        {lat: 41.22895, lng: 16.30635, msg: "Arrivato al palazzo 102, appartamento al piano 1."}
      ]
      // puoi aggiungere altri appartamenti qui
    };

    // Calcola distanza tra due coordinate
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // metri
      const toRad = x => x * Math.PI / 180;
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δφ = toRad(lat2 - lat1);
      const Δλ = toRad(lon2 - lon1);
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utter);
    }

    function startRoute() {
      const apt = document.getElementById("aptNumber").value.trim();
      if (!apartments[apt]) {
        document.getElementById("output").innerText = "Appartamento non trovato!";
        return;
      }

      checkpoints = apartments[apt];
      currentStep = 0;
      document.getElementById("inputDiv").style.display = "none";
      document.getElementById("output").innerText = "Attiva GPS e segui le istruzioni...";

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          document.getElementById("output").innerText =
            `Posizione attuale: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

          if (currentStep < checkpoints.length) {
            const cp = checkpoints[currentStep];
            const dist = distance(lat, lng, cp.lat, cp.lng);
            if (dist < RADIUS) {
              document.getElementById("output").innerText = cp.msg;
              speak(cp.msg);
              currentStep++;
            }
          } else {
            document.getElementById("output").innerText = "Sei arrivato a destinazione!";
            speak("Sei arrivato a destinazione!");
          }

        }, err => {
          document.getElementById("output").innerText = "Errore GPS: " + err.message;
        }, {enableHighAccuracy: true});
      } else {
        document.getElementById("output").innerText = "GPS non supportato.";
      }
    }
  </script>
</body>
</html>
